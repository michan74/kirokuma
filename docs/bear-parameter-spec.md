# くまパラメータ計算仕様

> **⚠️ この仕様は現在使用していません**
>
> この文書は初期検討時の「累積計算方式」の仕様です。
> 現在は「履歴ベース方式 + 影響度計算」を採用しています。
> 最新の仕様は `.emi/食事キロクマ.md` を参照してください。

---

## 概要（旧仕様）

食事画像から分析されたデータ（MealAnalysis）を累積計算し、くまの画像生成プロンプトに渡す。

---

## 設計方針

```
┌─────────────────────────────────────────────────────────┐
│  過去の MealAnalysis[]                                   │
├─────────────────────────────────────────────────────────┤
│  colors, nutrition → 累積して割合を再計算               │
│  characteristics → そのまま蓄積（重複排除）             │
└─────────────────────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────────────────────┐
│  BearParameters（累積データ）+ 今回の MealAnalysis       │
├─────────────────────────────────────────────────────────┤
│  → 画像生成AIに渡して、くまの見た目を決定               │
└─────────────────────────────────────────────────────────┘
```

---

## 入力データ

### MealAnalysis（1食分の分析結果）

| フィールド | 型 | 説明 | 例 |
|-----------|-----|------|-----|
| menuName | string | 料理名 | "鮭の塩焼き定食" |
| ingredients | string[] | 食材リスト | ["鮭", "ごはん", "味噌汁"] |
| characteristics | string[] | 料理の特徴 | ["和風", "ヘルシー", "あっさり"] |
| colors | Record<string, number> | 料理の色（上位3色 + 割合%、合計100%） | {"#FA8072": 40, "#FFFFFF": 35, "#228B22": 25} |
| nutrition | Record<string, number> | 栄養素（上位5つ + 割合%、合計100%） | {"タンパク質": 45, "炭水化物": 30, ...} |

---

## 出力データ

### BearParameters（累積データ、画像生成に渡す）

| フィールド | 型 | 説明 | 例 |
|-----------|-----|------|-----|
| colors | Record<string, number> | 累積された色（上位5色 + 割合%） | {"#FA8072": 30, "#FFFFFF": 25, ...} |
| nutrition | Record<string, number> | 累積された栄養素（上位5つ + 割合%） | {"タンパク質": 35, "炭水化物": 30, ...} |
| characteristics | string[] | 累積された特徴（重複排除） | ["和風", "ヘルシー", "こってり"] |

---

## 計算ロジック

### 1. colors（色の累積）

過去の食事の色を全部足して、割合を再計算

```
1食目: { "#FF0000": 50, "#FFFFFF": 50 }
2食目: { "#00FF00": 60, "#FFFFFF": 40 }
3食目: { "#FF0000": 30, "#0000FF": 70 }

累積:
#FF0000: 50 + 30 = 80
#FFFFFF: 50 + 40 = 90
#00FF00: 60
#0000FF: 70
合計: 300

→ 割合に変換（上位5色）
#FFFFFF: 30%
#FF0000: 27%
#0000FF: 23%
#00FF00: 20%
```

---

### 2. nutrition（栄養素の累積）

colors と同じ考え方で累積 → 割合再計算 → 上位5つ

---

### 3. characteristics（特徴の蓄積）

新しい特徴を先頭に追加、重複排除

```
過去: ["和風", "ヘルシー"]
今回: ["こってり", "和風"]

→ ["こってり", "和風", "ヘルシー"]
```

---

## 画像生成への反映

### 渡すデータ

| データ | 内容 |
|--------|------|
| BearParameters.colors | 累積された色（くまの毛色に反映） |
| BearParameters.nutrition | 累積された栄養素（AIが表情・ポーズを決定） |
| BearParameters.characteristics | 累積された特徴（くまの雰囲気に反映） |
| currentMeal | 今回の MealAnalysis（今食べたものを直接反映） |

### AIへの指示

- colors → くまの毛色に反映
- nutrition → 栄養バランスを見てくまの表情・ポーズを決定
- characteristics → くまの雰囲気に反映
- currentMeal → 今食べた料理を表現

---

## 次のステップ

1. [x] MealAnalysis の型を更新（models/index.ts）
2. [x] mealAnalysisPrompt.ts のプロンプトを更新
3. [x] BearParameters の型を更新（models/index.ts）
4. [ ] bearCalculator.ts の計算ロジックを更新
5. [ ] bearImagePrompt.ts のプロンプト生成を更新
